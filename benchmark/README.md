# Бенчмарк тесты для ImageFilter

Этот подпроект содержит инструменты для измерения производительности наложения фильтров на изображений.

## Установка

### Требования

- Python 3.7+
- Poetry или pip

### Быстрая установка
**Вариант 1: Установка через Poetry**

Если Poetry уже установлен:

```bash
cd benchmark
poetry install
```

**Вариант 2: Установка через pip**

```bash
pip install -r requirements.txt
```

После установки перезапустите терминал или добавьте Poetry в PATH.

## Подготовка датасета

Перед запуском бенчмарка необходимо создать тестовые изображения:

**С Poetry:**
```bash
poetry run generate-images
```

**Без Poetry:**
```bash
python -m benchmark.generate_test_images
```

Это создаст директорию `dataset/` с изображениями различных размеров:
- Маленькие (256x256, 512x512)
- Средние (1024x1024)
- Большие (2048x2048)
- Очень большие (3840x2160 - 4K)
- Различные соотношения сторон

Каждое изображение генерируется в трех вариантах паттернов:
- `gradient` - градиент
- `checkerboard` - шахматная доска
- `colorful` - цветное изображение с плавными переходами

## Запуск бенчмарка

### Базовый запуск

**С Poetry:**
```bash
poetry run benchmark
```

**Без Poetry (с виртуальным окружением):**
```bash
python -m benchmark.benchmark
```

### С параметрами

**С Poetry:**
```bash
# Указать путь к исполняемому файлу (относительно корня проекта)
poetry run benchmark --executable ../cmake-build-debug/bin/ImageFilter

# Изменить количество итераций (по умолчанию 3)
poetry run benchmark --iterations 5

# Использовать другую директорию с изображениями
poetry run benchmark --dataset custom_dataset

# Изменить выходную директорию
poetry run benchmark --output custom_output

# Тестировать только PNG файлы
poetry run benchmark --pattern "*.png"
```

**Без Poetry:**
```bash
python -m benchmark.benchmark --executable ../cmake-build-debug/bin/ImageFilter
python -m benchmark.benchmark --iterations 5
# и т.д.
```

### Полный пример

**С Poetry:**
```bash
poetry run benchmark \
    --executable ../cmake-build-debug/bin/ImageFilter \
    --dataset dataset \
    --output benchmark_output \
    --iterations 5 \
    --pattern "*.jpg"
```

**Без Poetry:**
```bash
python -m benchmark.benchmark \
    --executable ../cmake-build-debug/bin/ImageFilter \
    --dataset dataset \
    --output benchmark_output \
    --iterations 5 \
    --pattern "*.jpg"
```

## Результаты

Бенчмарк создает следующие файлы в директории `benchmark_output/`:

1. **benchmark_results.csv** - таблица со всеми результатами в формате CSV
2. **benchmark_results.json** - результаты в формате JSON
3. Обработанные изображения - результаты применения фильтров

### Формат CSV

| Фильтр | Изображение | Ширина | Высота | Пикселей | Время (с) | Успех | Ошибка |
|--------|-------------|--------|--------|----------|-----------|-------|--------|
| grayscale | small_gradient_256x256.jpg | 256 | 256 | 65536 | 0.001234 | Да | |

### Формат JSON

```json
{
  "results": [
    {
      "filter": "grayscale",
      "image": "small_gradient_256x256.jpg",
      "width": 256,
      "height": 256,
      "pixels": 65536,
      "time_seconds": 0.001234,
      "success": true,
      "error": ""
    }
  ]
}
```

## Статистика

После завершения бенчмарк выводит следующую статистику:

- **По фильтрам**: среднее, медианное, минимальное и максимальное время выполнения
- **Производительность**: мегапиксели в секунду (MP/s)
- **По размерам**: производительность для каждого размера изображения

### Пример вывода

```
================================================================================
СТАТИСТИКА БЕНЧМАРКА
================================================================================

Фильтр: grayscale
  Количество тестов: 24
  Среднее время: 0.0123s
  Медианное время: 0.0100s
  Стандартное отклонение: 0.0034s
  Минимальное время: 0.0056s
  Максимальное время: 0.0234s
  Производительность: 125.45 MP/s

Фильтр: blur
  Количество тестов: 24
  Среднее время: 0.2345s
  ...

--------------------------------------------------------------------------------
Производительность по размерам изображений:
--------------------------------------------------------------------------------

256x256:
  Среднее время: 0.0012s
  По фильтрам:
    grayscale: 0.0008s
    blur: 0.0123s
    sharpen: 0.0015s
```

## Разработка

### Активация виртуального окружения

```bash
poetry shell
```

### Запуск без Poetry

Если вы активировали виртуальное окружение через `poetry shell`:

```bash
python -m benchmark.benchmark
python -m benchmark.generate_test_images
```

## Примечания

- Бенчмарк автоматически усредняет результаты по нескольким итерациям для более точных измерений
- Каждый тест имеет таймаут 5 минут
- Ошибки выполнения сохраняются в результатах для анализа
- Обработанные изображения сохраняются в выходной директории для визуальной проверки
- Путь к исполняемому файлу по умолчанию указывает на `../cmake-build-debug/bin/ImageFilter.exe` относительно директории подпроекта

