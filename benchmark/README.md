# Бенчмарк тесты для ImageFilter

Этот подпроект содержит инструменты для измерения производительности наложения фильтров на изображения. Бенчмарк автоматически тестирует все 21 фильтр на различных размерах изображений и предоставляет детальную статистику производительности.

## Установка

### Требования

- Python 3.7+
- Poetry или pip

### Быстрая установка
**Вариант 1: Установка через Poetry**

Если Poetry уже установлен:

```bash
cd benchmark
poetry install
```

**Вариант 2: Установка через pip**

```bash
pip install -r requirements.txt
```

После установки перезапустите терминал или добавьте Poetry в PATH.

## Подготовка датасета

Перед запуском бенчмарка необходимо создать тестовые изображения:

**С Poetry:**
```bash
poetry run generate-images
```

**Без Poetry:**
```bash
python -m benchmark.generate_test_images
```

Это создаст директорию `dataset/` с изображениями различных размеров:

**Размеры изображений:**
- Маленькие: 256×256, 512×512
- Средние: 1024×1024
- Большие: 2048×2048
- Очень большие: 3840×2160 (4K)
- Портретные: 256×512
- Альбомные: 512×256
- Full HD: 1920×1080

**Паттерны изображений:**
- `gradient` - горизонтальный градиент с плавными переходами цветов
- `checkerboard` - шахматная доска (черно-белая)
- `colorful` - яркое цветное изображение с плавными переходами

Каждое изображение генерируется во всех трех вариантах паттернов, что обеспечивает разнообразие тестовых данных для различных типов фильтров.

## Запуск бенчмарка

### Базовый запуск

**С Poetry:**
```bash
poetry run benchmark --both  # Одиночные фильтры + цепочки
```

**Без Poetry (с виртуальным окружением):**
```bash
python -m benchmark.benchmark --both  # Одиночные фильтры + цепочки
```

**Примечание:** Необходимо указать один из режимов работы:
- `--chains` - только цепочки фильтров
- `--both` - одиночные фильтры + цепочки
- `--all-combinations` - все возможные комбинации фильтров

### С параметрами

**С Poetry:**
```bash
  poetry run benchmark --both  # Одиночные фильтры + цепочки (рекомендуется)
  poetry run benchmark --both --iterations 5
  poetry run benchmark --both --executable ../cmake-build-debug/bin/ImageFilter
  poetry run benchmark --both --dataset dataset --output benchmark_output
  poetry run benchmark --chains  # Только цепочки фильтров
  poetry run benchmark --all-combinations  # Все возможные комбинации
  poetry run benchmark --all-combinations --max-chain-length 3  # Ограничить длину цепочки
  poetry run benchmark --all-combinations --max-combinations-per-length 100  # Ограничить количество
```

**Без Poetry:**
```bash
python -m benchmark.benchmark --executable ../cmake-build-debug/bin/ImageFilter
python -m benchmark.benchmark --iterations 5
# и т.д.
```

### Полный пример

**С Poetry:**
```bash
poetry run benchmark --both \
    --executable ../cmake-build-debug/bin/ImageFilter \
    --dataset dataset \
    --output benchmark_output \
    --iterations 5 \
    --pattern "*.jpg"
```

**Без Poetry:**
```bash
python -m benchmark.benchmark --both \
    --executable ../cmake-build-debug/bin/ImageFilter \
    --dataset dataset \
    --output benchmark_output \
    --iterations 5 \
    --pattern "*.jpg"
```

## Тестируемые фильтры

Бенчмарк автоматически тестирует все 21 фильтр, разделенных на категории. Также поддерживается тестирование цепочек фильтров для оценки производительности комбинированных операций.

### Цветовые фильтры (6)
- `grayscale` - Преобразование в оттенки серого
- `sepia` - Эффект сепии
- `invert` - Инверсия цветов
- `brightness` - Изменение яркости
- `contrast` - Изменение контрастности
- `saturation` - Изменение насыщенности

### Геометрические фильтры (3)
- `flip_h` - Горизонтальное отражение
- `flip_v` - Вертикальное отражение
- `rotate90` - Поворот на 90 градусов

### Фильтры краёв и деталей (4)
- `sharpen` - Повышение резкости
- `edges` - Детекция краёв
- `emboss` - Эффект рельефа
- `outline` - Выделение контуров

### Фильтры размытия и шума (5)
- `blur` - Размытие по Гауссу
- `box_blur` - Размытие по прямоугольнику
- `motion_blur` - Размытие движения
- `median` - Медианный фильтр
- `noise` - Добавление шума

### Стилистические фильтры (3)
- `posterize` - Постеризация
- `threshold` - Пороговая бинаризация
- `vignette` - Виньетирование

## Тестирование цепочек фильтров

Бенчмарк автоматически тестирует предопределенные цепочки фильтров для оценки производительности комбинированных операций. Цепочки включают:

- Простые цепочки (2-3 фильтра): grayscale+sharpen, sepia+vignette, brightness+contrast и др.
- Средние цепочки (3-4 фильтра): grayscale+sharpen+vignette, brightness+contrast+saturation и др.
- Сложные цепочки (4-5 фильтров): комбинации из 4-5 фильтров
- Очень сложные цепочки (5+ фильтров): максимально сложные комбинации

Результаты цепочек помечаются специальным флагом в CSV файлах и учитываются в статистике отдельно от одиночных фильтров.

### Режим --all-combinations

При использовании флага `--all-combinations` бенчмарк автоматически генерирует и тестирует все возможные комбинации фильтров для цепочек разной длины. Порядок фильтров в комбинации не важен (например, `grayscale,sharpen` и `sharpen,grayscale` считаются одной комбинацией). Это может привести к очень большому количеству тестов, поэтому рекомендуется использовать параметры `--max-chain-length` и `--max-combinations-per-length` для ограничения количества комбинаций.

## Результаты

Бенчмарк создает следующие файлы:

**В директории `benchmark_output/`:**
- Обработанные изображения - результаты применения фильтров (для визуальной проверки)
- Изображения с цепочками фильтров (имена содержат `chain_`)

**В директории `benchmark_output/statistics/`:**
1. **benchmark_results.csv** - таблица со всеми результатами в формате CSV (включая цепочки)
2. **benchmark_statistics.csv** - агрегированная статистика по каждому фильтру и цепочке

### Формат CSV

| Фильтр/Цепочка | Тип | Длина цепочки | Изображение | Ширина | Высота | Пикселей | Время (с) | Успех | Ошибка |
|----------------|-----|---------------|-------------|--------|--------|----------|-----------|-------|--------|
| grayscale | Одиночный | 1 | small_gradient_256x256.jpg | 256 | 256 | 65536 | 0.001234 | Да | |
| grayscale,sharpen | Цепочка | 2 | small_gradient_256x256.jpg | 256 | 256 | 65536 | 0.002456 | Да | |

Поле "Тип" указывает, является ли запись результатом применения одиночного фильтра ("Одиночный") или цепочки фильтров ("Цепочка"). Поле "Длина цепочки" показывает количество фильтров в цепочке (1 для одиночных фильтров).

## Статистика

После завершения бенчмарк выводит детальную статистику:

### Общая статистика
- Общее количество тестов
- Количество успешных и неудачных тестов
- Количество фильтров по категориям

### Статистика по категориям фильтров
Для каждой категории (Цветовые, Геометрические, Края и детали, Размытие и шум, Стилистические):
- Количество тестов для каждого фильтра
- Среднее время выполнения
- Медианное время выполнения
- Стандартное отклонение
- Минимальное и максимальное время
- Производительность в мегапикселях в секунду (MP/s)

### Статистика по размерам изображений
- Среднее время обработки для каждого размера
- Разбивка по фильтрам для каждого размера

Все данные также сохраняются в CSV файлы для дальнейшего анализа.

### Пример вывода

```
================================================================================
СТАТИСТИКА БЕНЧМАРКА
================================================================================

Фильтр: grayscale
  Количество тестов: 24
  Среднее время: 0.0123s
  Медианное время: 0.0100s
  Стандартное отклонение: 0.0034s
  Минимальное время: 0.0056s
  Максимальное время: 0.0234s
  Производительность: 125.45 MP/s

Фильтр: blur
  Количество тестов: 24
  Среднее время: 0.2345s
  ...

--------------------------------------------------------------------------------
Производительность по размерам изображений:
--------------------------------------------------------------------------------

256x256:
  Среднее время: 0.0012s
  По фильтрам:
    grayscale: 0.0008s
    blur: 0.0123s
    sharpen: 0.0015s
```

## Разработка

### Активация виртуального окружения

```bash
poetry shell
```

### Запуск без Poetry

Если вы активировали виртуальное окружение через `poetry shell`:

```bash
python -m benchmark.benchmark
python -m benchmark.generate_test_images
```

## Особенности бенчмарка

### Точность измерений
- Автоматическое усреднение результатов по нескольким итерациям (по умолчанию 3)
- Использование `time.perf_counter()` для высокоточных измерений времени
- Обработка ошибок и таймаутов

### Надежность
- Каждый тест одиночного фильтра имеет таймаут 5 минут для предотвращения зависаний
- Тесты цепочек фильтров имеют таймаут 10 минут (из-за большей сложности)
- Ошибки выполнения сохраняются в результатах для анализа
- Безопасная обработка кодировок при чтении вывода программы

### Визуальная проверка
- Обработанные изображения сохраняются в выходной директории
- Имена файлов содержат название исходного изображения и примененный фильтр
- Формат для одиночных фильтров: `{image_name}_{filter_name}.jpg`
- Формат для цепочек: `{image_name}_chain_{filter1}_{filter2}_...jpg`

### Пути к исполняемым файлам
- По умолчанию: `../bin/ImageFilter.exe` (Windows) или `../bin/ImageFilter` (Linux/macOS)
- Можно указать другой путь через параметр `--executable`
- Путь определяется относительно директории подпроекта `benchmark/`

### Поддерживаемые форматы изображений
Бенчмарк работает с любыми форматами, поддерживаемыми ImageFilter:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- BMP (.bmp)

Формат определяется автоматически по расширению файла. Можно фильтровать файлы по шаблону с помощью параметра `--pattern`.

## Интерпретация результатов

### Производительность (MP/s)
- Показывает, сколько мегапикселей обрабатывается за секунду

### Время выполнения
- Зависит от размера изображения и сложности фильтра
- Фильтры размытия обычно медленнее из-за необходимости обработки соседних пикселей
- Простые цветовые фильтры (grayscale, invert) обычно самые быстрые

### Стандартное отклонение
- Низкое отклонение указывает на стабильную производительность
- Высокое отклонение может указывать на влияние системных факторов (кэш, другие процессы)

