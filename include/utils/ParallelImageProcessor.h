#pragma once

#include <cstdint>
#include <execution>
#include <functional>
#include <memory>
#include <thread>
#include <vector>
#include <algorithm>

// Forward declarations
class IThreadPool;

/**
 * @brief Утилита для параллельной обработки изображений
 * 
 * Предоставляет функции для распараллеливания обработки изображений
 * путем разделения работы на несколько потоков. Оптимизирует производительность
 * для больших изображений, используя все доступные ядра процессора.
 * 
 * Особенности:
 * - Автоматически определяет оптимальное количество потоков
 * - Разделяет изображение на горизонтальные полосы (строки)
 * - Обеспечивает безопасность потоков (thread-safe)
 * - Использует ThreadPool для переиспользования потоков
 * - Поддерживает std::execution::par_unseq для векторных операций
 * - Адаптивный выбор между последовательной и параллельной обработкой
 * 
 * @note Адаптивный выбор:
 *   - Маленькие изображения (< 100x100): последовательная обработка
 *   - Средние изображения: параллельная обработка с меньшим количеством потоков
 *   - Большие изображения: параллельная обработка со всеми доступными потоками
 */
class ParallelImageProcessor
{
public:
    /**
     * @brief Обрабатывает изображение построчно в параллельных потоках
     * 
     * Разделяет изображение на полосы и обрабатывает каждую полосу
     * в отдельном потоке. Функция обработки получает диапазон строк [start_row, end_row).
     * 
     * Автоматически выбирает оптимальный режим обработки на основе размера изображения:
     * - Маленькие изображения (< 100x100 пикселей): последовательная обработка
     * - Средние изображения: параллельная обработка с уменьшенным количеством потоков
     * - Большие изображения: параллельная обработка со всеми доступными потоками
     * 
     * @param height Высота изображения в пикселях
     * @param width Ширина изображения в пикселях (используется для адаптивного выбора)
     * @param processRowRange Функция обработки диапазона строк: void(int start_row, int end_row)
     * @param thread_pool Пул потоков для выполнения задач (nullptr = использовать глобальный пул)
     * @param num_threads Количество потоков (0 = автоматическое определение на основе размера, используется только если thread_pool == nullptr)
     */
    static void processRowsParallel(
        int height,
        int width,
        const std::function<void(int start_row, int end_row)>& processRowRange,
        IThreadPool* thread_pool = nullptr,
        int num_threads = 0
    );

    /**
     * @brief Перегрузка для обратной совместимости (без width)
     * 
     * Использует только height для определения режима обработки.
     * Рекомендуется использовать версию с width для лучшей оптимизации.
     * 
     * @param height Высота изображения в пикселях
     * @param processRowRange Функция обработки диапазона строк: void(int start_row, int end_row)
     * @param thread_pool Пул потоков для выполнения задач (nullptr = использовать глобальный пул)
     * @param num_threads Количество потоков (0 = автоматическое определение, используется только если thread_pool == nullptr)
     */
    static void processRowsParallel(
        int height,
        const std::function<void(int start_row, int end_row)>& processRowRange,
        IThreadPool* thread_pool = nullptr,
        int num_threads = 0
    );


    /**
     * @brief Получает оптимальное количество потоков для обработки
     * 
     * Возвращает количество потоков, равное количеству доступных ядер процессора,
     * или 1, если определение невозможно.
     * 
     * @return Количество потоков для использования
     */
    static int getOptimalThreadCount() noexcept;

    /**
     * @brief Определяет, следует ли использовать параллельную обработку
     * 
     * Адаптивный выбор на основе размера изображения:
     * - Маленькие изображения (< 100x100): false (последовательная обработка)
     * - Средние и большие изображения: true (параллельная обработка)
     * 
     * @param width Ширина изображения в пикселях
     * @param height Высота изображения в пикселях
     * @return true если рекомендуется параллельная обработка, false иначе
     */
    static bool shouldUseParallelProcessing(int width, int height) noexcept;

    /**
     * @brief Получает адаптивное количество потоков на основе размера изображения
     * 
     * @param width Ширина изображения в пикселях
     * @param height Высота изображения в пикселях
     * @param requested_threads Запрошенное количество потоков (0 = автоматическое)
     * @return Оптимальное количество потоков для данного размера изображения
     */
    static int getAdaptiveThreadCount(int width, int height, int requested_threads = 0) noexcept;

private:

    /**
     * @brief Порог размера изображения для последовательной обработки
     * 
     * Изображения меньше этого размера (width * height) обрабатываются последовательно.
     */
    static constexpr int SEQUENTIAL_THRESHOLD = 100 * 100; // 100x100 пикселей

    /**
     * @brief Порог размера изображения для использования всех потоков
     * 
     * Изображения больше этого размера используют все доступные потоки.
     */
    static constexpr int FULL_PARALLEL_THRESHOLD = 1000 * 1000; // 1000x1000 пикселей
};



