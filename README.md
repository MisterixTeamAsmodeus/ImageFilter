# ImageFilter - Приложение для обработки изображений

Высокопроизводительное консольное приложение на C++20 для применения фильтров к изображениям с самостоятельной реализацией всех алгоритмов обработки изображений. Поддерживает форматы JPEG, PNG и BMP.

## Технические характеристики

- **Язык**: C++20
- **Компилятор**: Clang (предпочтительно) или любой компилятор с поддержкой C++20
- **Библиотеки**: STB Image (автоматически загружается через CMake FetchContent)
- **Система сборки**: CMake 3.20+
- **Параллелизм**: Многопоточная обработка с использованием std::thread

## Реализованные фильтры

Проект включает 22 фильтра, разделенных на 5 категорий:

### Цветовые фильтры (6)

1. **grayscale** - Преобразование в оттенки серого
   - Формула: Y = 0.299R + 0.587G + 0.114B
   - Основана на восприятии яркости человеческим глазом

2. **sepia** - Эффект сепии (винтажный)
   - Применяет классический сепия-тон для создания винтажного эффекта

3. **invert** - Инверсия цветов
   - Инвертирует все цветовые каналы: R' = 255 - R, G' = 255 - G, B' = 255 - B

4. **brightness** - Изменение яркости
   - Увеличивает или уменьшает яркость изображения (коэффициент по умолчанию: 1.2)

5. **contrast** - Изменение контрастности
   - Регулирует контрастность изображения (коэффициент по умолчанию: 1.5)

6. **saturation** - Изменение насыщенности
   - Изменяет насыщенность цветов (коэффициент по умолчанию: 1.5)

### Геометрические фильтры (3)

7. **flip_h** - Горизонтальное отражение
   - Отражает изображение по вертикальной оси

8. **flip_v** - Вертикальное отражение
   - Отражает изображение по горизонтальной оси

9. **rotate90** - Поворот на 90 градусов
   - Поворачивает изображение на 90 градусов по часовой стрелке

### Фильтры краёв и деталей (4)

10. **sharpen** - Повышение резкости
    - Использует классическое ядро unsharp masking
    - Усиливает края и детали изображения

11. **edges** - Детекция краёв
    - Использует оператор Собеля для обнаружения границ объектов

12. **emboss** - Эффект рельефа
    - Создает эффект объемного рельефа на изображении

13. **outline** - Выделение контуров
    - Выделяет контуры объектов на изображении

### Фильтры размытия и шума (5)

14. **blur** - Размытие по Гауссу
    - Использует separable kernel для оптимизации производительности
    - Радиус размытия: 5.0 (по умолчанию)
    - Оптимизация: O(2N) вместо O(N²) операций на пиксель

15. **box_blur** - Размытие по прямоугольнику
    - Простое размытие с использованием прямоугольного ядра (радиус: 5)

16. **motion_blur** - Размытие движения
    - Имитирует эффект движения камеры (длина: 10, угол: 0°)

17. **median** - Медианный фильтр
    - Удаляет шум и сглаживает изображение (радиус: 2)

18. **noise** - Добавление шума
    - Добавляет случайный шум к изображению (интенсивность: 0.1)

### Стилистические фильтры (3)

19. **posterize** - Постеризация
    - Уменьшает количество цветовых уровней (4 уровня по умолчанию)

20. **threshold** - Пороговая бинаризация
    - Преобразует изображение в черно-белое по порогу (порог: 128)

21. **vignette** - Виньетирование
    - Создает эффект затемнения по краям изображения (сила: 0.5)

## Сборка проекта

### Требования

- CMake 3.20 или выше
- Компилятор Clang с поддержкой C++20 (рекомендуется) или любой другой компилятор с поддержкой C++20
- Git (для загрузки зависимостей через FetchContent)

### Инструкция по сборке

#### Windows (с использованием Clang)

```powershell
# Создаем директорию для сборки
mkdir build
cd build

# Настраиваем проект с указанием Clang
cmake .. -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Release

# Собираем проект
cmake --build . --config Release

# Исполняемый файл будет в build/bin/ImageFilter.exe
```

#### Linux/macOS (с использованием Clang)

```bash
# Создаем директорию для сборки
mkdir build
cd build

# Настраиваем проект с указанием Clang
cmake .. -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Release

# Собираем проект
cmake --build . --config Release

# Исполняемый файл будет в build/bin/ImageFilter
```

### Сборка с тестами

```bash
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON
cmake --build . --config Release

# Запуск тестов
ctest
# или
./bin/ImageFilterTests
```

### Установка

```bash
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
cmake --build . --config Release
cmake --install .
```

### Альтернативная сборка (если Clang недоступен)

Если Clang не установлен, проект можно собрать с другим компилятором C++20:

```bash
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . --config Release
```

## Использование

### Синтаксис команды

```bash
./ImageFilter <input> <filter> <output> [опции]
```

### Основные параметры

- `input` - путь к входному изображению (JPEG, PNG или BMP)
- `filter` - название фильтра или цепочка фильтров через запятую (см. список выше)
- `output` - путь к выходному изображению (JPEG, PNG или BMP)

### Опции командной строки

- `--list-filters` - вывести список всех доступных фильтров
- `--filter-info <name>` - вывести подробную информацию о конкретном фильтре
- `-q, --quiet` - тихий режим (минимальный вывод)
- `--log-level <LEVEL>` - установить уровень логирования (DEBUG, INFO, WARNING, ERROR)
- `--jpeg-quality <value>` - качество сохранения JPEG изображений (0-100, по умолчанию 90)
- `--preserve-alpha` - сохранять альфа-канал при загрузке и сохранении (RGBA)
- `--force-rgb` - принудительно преобразовать RGBA в RGB перед обработкой
- `--preset <file>` - загрузить пресет фильтров из файла
- `--save-preset <name>` - сохранить текущую цепочку фильтров как пресет
- `--preset-dir <dir>` - директория для сохранения/загрузки пресетов (по умолчанию: ./presets)

### Параметры фильтров

Многие фильтры поддерживают настройку параметров через командную строку:

- `--brightness-factor <value>` - коэффициент яркости (по умолчанию 1.2)
- `--contrast-factor <value>` - коэффициент контрастности (по умолчанию 1.5)
- `--saturation-factor <value>` - коэффициент насыщенности (по умолчанию 1.5)
- `--blur-radius <value>` - радиус размытия по Гауссу (по умолчанию 5.0)
- `--box-blur-radius <value>` - радиус размытия по прямоугольнику (по умолчанию 5)
- `--motion-blur-length <value>` - длина размытия движения (по умолчанию 10)
- `--motion-blur-angle <value>` - угол размытия движения в градусах (по умолчанию 0.0)
- `--median-radius <value>` - радиус медианного фильтра (по умолчанию 2)
- `--noise-intensity <value>` - интенсивность шума 0.0-1.0 (по умолчанию 0.1)
- `--posterize-levels <value>` - количество уровней постеризации 2-256 (по умолчанию 4)
- `--threshold-value <value>` - пороговое значение бинаризации 0-255 (по умолчанию 128)
- `--vignette-strength <value>` - сила виньетирования 0.0-1.0 (по умолчанию 0.5)
- `--counter-clockwise` - поворот против часовой стрелки (для rotate90)
- `--jpeg-quality <value>` - качество сохранения JPEG изображений 0-100 (по умолчанию 90, применяется только для JPEG)

### Параметры пакетной обработки

- `--batch` - включить пакетный режим обработки
- `--input-dir <dir>` - входная директория с изображениями (для пакетного режима)
- `--output-dir <dir>` - выходная директория для обработанных изображений (для пакетного режима)
- `--recursive` - рекурсивный обход поддиректорий (для пакетного режима)
- `--pattern <pattern>` - шаблон для фильтрации файлов (например, *.jpg, *.png)

### Примеры использования

#### Преобразование в оттенки серого

```bash
./ImageFilter input.jpg grayscale output_gray.jpg
```

#### Применение размытия по Гауссу

```bash
./ImageFilter input.jpg blur output_blurred.jpg
```

#### Повышение резкости

```bash
./ImageFilter input.jpg sharpen output_sharpened.jpg
```

#### Применение эффекта сепии

```bash
./ImageFilter input.jpg sepia output_sepia.jpg
```

#### Детекция краёв

```bash
./ImageFilter input.jpg edges output_edges.jpg
```

#### Поворот изображения

```bash
./ImageFilter input.jpg rotate90 output_rotated.jpg
```

#### Применение фильтра с параметрами

```bash
# Размытие с радиусом 10.0
./ImageFilter input.jpg blur output.jpg --blur-radius 10.0

# Яркость с коэффициентом 1.5
./ImageFilter input.jpg brightness output.jpg --brightness-factor 1.5

# Пороговая бинаризация с порогом 100
./ImageFilter input.jpg threshold output.jpg --threshold-value 100

# Сохранение с низким качеством JPEG (для уменьшения размера файла)
./ImageFilter input.jpg grayscale output.jpg --jpeg-quality 50

# Сохранение с максимальным качеством JPEG
./ImageFilter input.jpg blur output.jpg --jpeg-quality 100
```

#### Применение цепочки фильтров

```bash
# Применение нескольких фильтров подряд
./ImageFilter input.jpg "grayscale,sharpen,blur" output.jpg

# Комбинация с параметрами
./ImageFilter input.jpg "brightness,contrast" output.jpg --brightness-factor 1.3 --contrast-factor 1.8
```

#### Получение информации о фильтрах

```bash
# Список всех фильтров
./ImageFilter --list-filters

# Информация о конкретном фильтре
./ImageFilter --filter-info blur
```

#### Тихий режим и логирование

```bash
# Тихий режим (минимальный вывод)
./ImageFilter input.jpg grayscale output.jpg --quiet

# Установка уровня логирования
./ImageFilter input.jpg blur output.jpg --log-level DEBUG
```

#### Работа с альфа-каналом

```bash
# Сохранение альфа-канала (RGBA)
./ImageFilter input.png grayscale output.png --preserve-alpha

# Принудительное преобразование RGBA в RGB
./ImageFilter input.png blur output.jpg --force-rgb
```

#### Пакетная обработка

```bash
# Обработка всех изображений в директории
./ImageFilter --batch --input-dir ./images --output-dir ./processed "grayscale,sharpen" --output-dir ./processed

# Рекурсивная обработка с фильтрацией по шаблону
./ImageFilter --batch --input-dir ./photos --output-dir ./filtered --recursive --pattern "*.jpg" "blur,vignette"

# Пакетная обработка с параметрами фильтров
./ImageFilter --batch --input-dir ./input --output-dir ./output "brightness,contrast" --brightness-factor 1.3 --contrast-factor 1.8
```

#### Работа с пресетами

```bash
# Сохранение цепочки фильтров как пресет
./ImageFilter input.jpg "grayscale,sharpen,vignette" output.jpg --save-preset bw_sharp_vignette

# Применение сохраненного пресета
./ImageFilter input.jpg output.jpg --preset bw_sharp_vignette

# Использование другой директории для пресетов
./ImageFilter input.jpg output.jpg --preset my_preset --preset-dir ./my_presets
```

## Особенности реализации


### Оптимизации производительности

1. **Separable Kernel для Gaussian Blur**
   - Вместо применения двумерного ядра N×N (O(N²) операций)
   - Применяется одномерное ядро дважды: горизонтально и вертикально (O(2N) операций)
   - Значительное ускорение для больших радиусов размытия

2. **Многопоточная обработка**
   - Автоматическое определение количества доступных ядер процессора
   - Разделение изображения на горизонтальные полосы для параллельной обработки
   - Использование std::thread для распараллеливания вычислений
   - Оптимизирует производительность для больших изображений

3. **Lookup Tables (LUT)**
   - Предвычисленные таблицы для ускорения операций
   - Использование для оптимизации цветовых преобразований
   - Кэширование результатов вычислений

4. **Оптимизация компилятора**
   - Использование флагов оптимизации -O3 для Release сборки
   - Включение предупреждений компилятора для повышения качества кода

### Структура проекта

```
ImageFilter/
├── include/              # Заголовочные файлы
│   ├── filters/         # Интерфейсы и заголовки фильтров
│   ├── utils/           # Утилиты (параллельная обработка, пулы потоков, LUT и др.)
│   └── ImageProcessor.h # Основной класс для работы с изображениями
├── src/                 # Исходные файлы
│   ├── filters/         # Реализации фильтров
│   ├── utils/           # Реализации утилит
│   ├── ImageProcessor.cpp
│   └── main.cpp         # Точка входа приложения
├── tests/               # Unit-тесты
├── benchmark/           # Инструменты для бенчмарка (см. benchmark/README.md)
├── docs/                # Документация для разработчиков
└── CMakeLists.txt       # Конфигурация сборки
```

## Поддерживаемые форматы

Приложение поддерживает следующие форматы изображений:

- **JPEG** (.jpg, .jpeg) - чтение и запись с настраиваемым качеством (0-100)
- **PNG** (.png) - чтение и запись с поддержкой альфа-канала (RGBA)
- **BMP** (.bmp) - чтение и запись 24-битных RGB изображений

Формат определяется автоматически по расширению файла.

## Зависимости

Все зависимости автоматически загружаются через CMake FetchContent:

- **STB Image** (stb_image.h, stb_image_write.h)
  - Используется для чтения и записи JPEG/PNG файлов
  - Все алгоритмы обработки реализованы самостоятельно

- **CLI11** (v2.4.1)
  - Библиотека для парсинга аргументов командной строки
  - Используется для улучшенного CLI интерфейса

- **Google Test** (v1.14.0, опционально)
  - Фреймворк для unit-тестирования
  - Загружается только при включении опции BUILD_TESTS

## Бенчмарк

Проект включает инструменты для измерения производительности фильтров. Подробная информация доступна в [benchmark/README.md](benchmark/README.md).

## Улучшения проекта

### Реализованные улучшения

1. **Unit-тестирование**
   - Добавлен Google Test для тестирования компонентов
   - Тесты для ImageProcessor, фильтров и ParallelImageProcessor
   - Запуск через `ctest` или `./bin/ImageFilterTests`

2. **Улучшенный CLI**
   - Библиотека CLI11 для парсинга аргументов
   - Поддержка параметров фильтров через командную строку
   - Применение цепочек фильтров через запятую
   - Команды `--list-filters` и `--filter-info`

3. **Валидация параметров**
   - Автоматическая валидация параметров фильтров в конструкторах
   - Использование значений по умолчанию при некорректных параметрах

4. **Move-семантика**
   - Move-конструктор и move-оператор присваивания для ImageProcessor
   - Запрет копирования для безопасности памяти

5. **Структурированное логирование**
   - Класс Logger с уровнями (DEBUG, INFO, WARNING, ERROR)
   - Настраиваемый уровень логирования через `--log-level`
   - Тихий режим через `--quiet`

6. **Улучшения CMake**
   - Опция `BUILD_TESTS` для сборки тестов
   - Опция `ENABLE_INSTALL` для установки
   - Версионирование через CMakePackageConfigHelpers

7. **Пакетная обработка**
   - Обработка множества изображений в одной команде
   - Рекурсивный обход директорий
   - Фильтрация файлов по шаблону
   - Отображение прогресса обработки

8. **Пресеты фильтров**
   - Сохранение и загрузка цепочек фильтров
   - JSON-формат для хранения конфигураций
   - Упрощение повторного использования сложных цепочек

9. **Поддержка BMP формата**
   - Поддержка 24-битных RGB изображений
   - Автоматическое преобразование RGBA в RGB при сохранении

10. **Работа с альфа-каналом**
    - Поддержка RGBA изображений
    - Опции для сохранения или преобразования альфа-канала
    - Автоматическое преобразование при необходимости

## FAQ

### Как применить несколько фильтров подряд?

Используйте запятую для разделения фильтров:
```bash
./ImageFilter input.jpg "grayscale,sharpen,blur" output.jpg
```

### Как настроить параметры фильтра?

Используйте соответствующие опции командной строки:
```bash
./ImageFilter input.jpg blur output.jpg --blur-radius 10.0
```

### Как отключить вывод в консоль?

Используйте флаг `--quiet`:
```bash
./ImageFilter input.jpg grayscale output.jpg --quiet
```

### Как запустить тесты?

Соберите проект с опцией `-DBUILD_TESTS=ON` и запустите:
```bash
ctest
```

### Поддерживаются ли другие форматы изображений?

В настоящее время поддерживаются JPEG, PNG и BMP. Формат определяется автоматически по расширению файла.

### Как обработать несколько изображений сразу?

Используйте пакетный режим:
```bash
./ImageFilter --batch --input-dir ./input --output-dir ./output "grayscale,sharpen"
```

### Как сохранить и использовать цепочку фильтров?

Сохраните пресет:
```bash
./ImageFilter input.jpg "grayscale,sharpen,vignette" output.jpg --save-preset my_preset
```

Используйте пресет:
```bash
./ImageFilter input.jpg output.jpg --preset my_preset
```

## Лицензия

Учебный проект для изучения обработки изображений на C++20.

